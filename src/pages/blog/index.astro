---
import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Container from "@components/Container.astro";
import PostCard from "@components/PostCard.astro";
import { BLOG } from "@consts";
import { getTextStats } from "@lib/post-metrics";

const showDrafts = import.meta.env.DEV;
const entries = (await getCollection("blog"))
  .filter((post) => showDrafts || !post.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const posts = entries.map((entry) => ({
  entry,
  stats: getTextStats(entry.body ?? ""),
}));

type PostsByYear = Record<string, typeof posts>;
const byYear: PostsByYear = {};

for (const post of posts) {
  const year = post.entry.data.date.getFullYear().toString();
  if (!byYear[year]) {
    byYear[year] = [];
  }
  byYear[year].push(post);
}

const years = Object.keys(byYear).sort((a, b) => parseInt(b) - parseInt(a));
---

<Layout title={BLOG.TITLE} description={BLOG.DESCRIPTION}>
  <Container>
    <div class="space-y-10">
      <section class="space-y-2 text-center sm:text-left">
        <h1 class="text-xl font-semibold text-black dark:text-white">記事一覧</h1>
        <p class="text-sm text-black/70 dark:text-white/70">
        </p>
      </section>

      {years.length === 0 && (
        <div class="text-sm text-black/70 dark:text-white/70">まだ投稿がありません。</div>
      )}

      {years.map((year) => (
        <section class="space-y-4">
          <div class="flex flex-col items-center gap-1 text-center sm:flex-row sm:items-baseline sm:gap-2 sm:text-left">
            <h2 class="text-lg font-semibold text-black dark:text-white">{year}</h2>
            <span class="text-sm text-black/50 dark:text-white/50">({byYear[year].length}件)</span>
          </div>
          <ul class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {byYear[year].map((post, index) => (
              <li class={index === 0 ? "md:col-span-2 md:aspect-square" : "md:aspect-square"}>
                <PostCard entry={post.entry} stats={post.stats}/>
              </li>
            ))}
          </ul>
        </section>
      ))}
    </div>
  </Container>
</Layout>
