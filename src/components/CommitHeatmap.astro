---
type Day = {
    date: string;
    count: number;
    className: string;
};

type Props = {
    weeks: Day[][];
    monthLabels: string[];
    cellSize?: number;
    gap?: number;
};

const { weeks, monthLabels, cellSize, gap = 2 } = Astro.props;
const weekCount = weeks.length;
const labelHeight = cellSize
    ? `${Math.max(8, Math.round(cellSize * 0.9))}px`
    : "calc(var(--cell-size) + 4px)";
const labelOffset = cellSize
    ? `${Math.max(8, Math.round(cellSize * 0.9)) + 4}px`
    : "calc(var(--cell-size) + 8px)";
const columnsStyle = `grid-template-columns: repeat(${weekCount}, var(--cell-size)); gap: var(--cell-gap);`;
const weeksStyle = "grid-auto-columns: var(--cell-size); gap: var(--cell-gap);";
const dayStyle =
    "width: var(--cell-size); height: var(--cell-size); border-radius: 2px;";
const rootStyle = cellSize
    ? `--cell-size: ${cellSize}px; --cell-gap: ${gap}px;`
    : `--cell-size: clamp(4px, 0.85vw, 10px); --cell-gap: clamp(1px, 0.3vw, 2px);`;
---

<div class="relative" data-heatmap>
    <div class="min-w-0">
        <div class="relative">
            <div
                class="absolute top-0 right-0 left-0 grid text-[9px] text-black/35 dark:text-white/35"
                style={`${columnsStyle} height: ${labelHeight}; ${rootStyle}`}
            >
                {
                    monthLabels.map((label) => (
                        <span
                            class="whitespace-nowrap"
                            style={`height: ${labelHeight}; line-height: ${labelHeight};`}
                        >
                            {label}
                        </span>
                    ))
                }
            </div>
            <div
                class="grid grid-flow-col"
                style={`padding-top: ${labelOffset}; ${weeksStyle} ${rootStyle}`}
            >
                {
                    weeks.map((week) => (
                        <div
                            class="grid grid-rows-7"
                            style={`gap: var(--cell-gap); ${rootStyle}`}
                        >
                            {week.map((day) => (
                                <span
                                    class={day.className}
                                    style={dayStyle}
                                    data-heatmap-day
                                    data-date={day.date}
                                    data-count={day.count}
                                    title={`${day.date}：${day.count}件`}
                                />
                            ))}
                        </div>
                    ))
                }
            </div>
        </div>
    </div>
    <div
        class="pointer-events-none fixed left-0 top-0 z-50 hidden rounded-md border border-black/10 bg-white px-2 py-1 text-[10px] text-black shadow-sm dark:border-white/10 dark:bg-neutral-900 dark:text-white"
        data-heatmap-tooltip
    ></div>
</div>

<script is:inline>
    const attachHeatmapTooltips = () => {
        document.querySelectorAll("[data-heatmap]").forEach((root) => {
            if (root.dataset.tooltipReady === "true") return;
            root.dataset.tooltipReady = "true";

            const tooltip = root.querySelector("[data-heatmap-tooltip]");
            if (!tooltip) return;

            root.addEventListener("mousemove", (event) => {
                const target = event.target.closest("[data-heatmap-day]");
                if (!(target instanceof HTMLElement)) {
                    tooltip.classList.add("hidden");
                    return;
                }
                const date = target.dataset.date ?? "";
                const count = target.dataset.count ?? "0";
                tooltip.textContent = `${date}：${count}件`;
                const targetRect = target.getBoundingClientRect();
                const x = targetRect.left + targetRect.width / 2;
                const y = targetRect.top - 8;
                tooltip.style.transform = `translate(${x}px, ${y}px) translate(-50%, -100%)`;
                tooltip.classList.remove("hidden");
            });

            root.addEventListener("mouseleave", () => {
                tooltip.classList.add("hidden");
            });
        });
    };

    const run = () => attachHeatmapTooltips();
    run();
    document.addEventListener("astro:page-load", run);
</script>
